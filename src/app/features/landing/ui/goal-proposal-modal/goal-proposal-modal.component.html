<app-popup>
    <app-popup-close-button (close)="dialogRef.close()" />

    <div class="proposal-modal">
        <!-- Header - не скроллится -->
        <div class="proposal-modal__header">
            <svg class="proposal-modal__icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="12" r="6" fill="currentColor"/>
                <circle cx="12" cy="12" r="3" fill="white"/>
            </svg>
            <span class="proposal-modal__step">Step {{ currentStep }} of 2</span>
        </div>

        <!-- Scrollable content -->
        <div class="proposal-modal__content">
            <!-- Step 1: Define Your Goal -->
            @if (currentStep === 1) {
                <h2 class="proposal-modal__title">Define Your Goal</h2>
                <p class="proposal-modal__subtitle">
                    Set a target and pledge something meaningful if the community reaches it.
                </p>

                <form [formGroup]="goalForm">
                <!-- Goal Type Selection -->
                <div class="form-group">
                    <label class="form-label">What do you want to grow?</label>
                    <div class="button-group">
                        <button
                            type="button"
                            class="option-button"
                            [class.option-button--active]="goalTypeValue === 'supporters'"
                            (click)="selectGoalType('supporters')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>Number of<br>Supporters</span>
                        </button>
                        <button
                            type="button"
                            class="option-button"
                            [class.option-button--active]="goalTypeValue === 'totalPulses'"
                            (click)="selectGoalType('totalPulses')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                            <span>Total Pulses</span>
                        </button>
                        <button
                            type="button"
                            class="option-button"
                            [class.option-button--active]="goalTypeValue === 'dailyActivity'"
                            (click)="selectGoalType('dailyActivity')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span>Daily Activity</span>
                        </button>
                    </div>
                </div>

                <!-- Target Input -->
                <div class="form-group">
                    <label class="form-label">
                        Set your target
                        <span class="form-label__hint">Currently: {{ currentStats }}</span>
                    </label>
                    <div class="input-with-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6" fill="currentColor"/>
                        </svg>
                        <input
                            type="number"
                            class="form-input"
                            formControlName="target"
                            [placeholder]="'Min: ' + minTarget" />
                    </div>
                    <p class="form-hint">Goal must be at least {{ minTarget }}</p>
                </div>

                <!-- Date Inputs -->
                @if (goalTypeValue === 'dailyActivity') {
                    <div class="form-group">
                        <label class="form-label">Target Date</label>
                        <input
                            type="date"
                            class="form-input form-input--date"
                            formControlName="targetDate" />
                        <p class="form-hint">The day you want to achieve this daily activity level</p>
                    </div>
                } @else {
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input
                                type="date"
                                class="form-input form-input--date"
                                formControlName="startDate" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input
                                type="date"
                                class="form-input form-input--date"
                                formControlName="endDate" />
                        </div>
                    </div>
                }

                <!-- Pledge Type Selection -->
                <div class="form-group">
                    <label class="form-label">What will you pledge?</label>
                    <div class="button-group button-group--two">
                        <button
                            type="button"
                            class="option-button option-button--pledge"
                            [class.option-button--active]="pledgeTypeValue === 'donation'"
                            (click)="selectPledgeType('donation')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            <div class="option-button__content">
                                <span class="option-button__title">Donation</span>
                                <span class="option-button__subtitle">Monetary contribution</span>
                            </div>
                        </button>
                        <button
                            type="button"
                            class="option-button option-button--pledge"
                            [class.option-button--active]="pledgeTypeValue === 'action'"
                            (click)="selectPledgeType('action')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                            <div class="option-button__content">
                                <span class="option-button__title">Action</span>
                                <span class="option-button__subtitle">Commitment or activity</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Donation Amount (if donation selected) -->
                @if (pledgeTypeValue === 'donation') {
                    <div class="form-group">
                        <label class="form-label">Donation amount (USD)</label>
                        <div class="input-with-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            <input
                                type="number"
                                class="form-input"
                                formControlName="donationAmount"
                                placeholder="100" />
                        </div>
                    </div>
                }

                <!-- Pledge Description -->
                <div class="form-group">
                    <label class="form-label">
                        Describe your pledge *
                        <a href="#" class="form-label__link" (click)="$event.preventDefault()">See examples</a>
                    </label>
                    <textarea
                        class="form-textarea"
                        formControlName="pledgeDescription"
                        [placeholder]="pledgeTypeValue === 'donation' 
                            ? 'I will donate to [organization/cause]...' 
                            : 'I will [host an event / create content / take action]...'"></textarea>
                </div>

                <button
                    type="button"
                    class="btn-continue"
                    [disabled]="!goalForm.valid"
                    (click)="goToNextStep()">
                    Continue
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
            </form>
            }

            <!-- Step 2: About You -->
            @if (currentStep === 2) {
                <h2 class="proposal-modal__title">About You</h2>
                <p class="proposal-modal__subtitle">
                    Tell us who's backing this goal so supporters know it's real.
                </p>

            <form [formGroup]="aboutForm">
                <!-- Goal Summary -->
                <div class="goal-summary">
                    <div class="goal-summary__label">YOUR GOAL</div>
                    <div class="goal-summary__content">
                        Grow <strong>
                            @if (goalTypeValue === 'supporters') { Number of Supporters }
                            @if (goalTypeValue === 'totalPulses') { Total Pulses }
                            @if (goalTypeValue === 'dailyActivity') { Daily Activity }
                        </strong> from {{ currentStats }} to {{ goalForm.get('target')?.value }}
                    </div>
                    <div class="goal-summary__date">
                        @if (goalTypeValue === 'dailyActivity') {
                            {{ goalForm.get('targetDate')?.value | date: 'MMM d, y' }}
                        } @else {
                            {{ goalForm.get('startDate')?.value | date: 'MMM d' }} – {{ goalForm.get('endDate')?.value | date: 'MMM d, y' }}
                        }
                    </div>
                </div>

                <!-- Champion Type Selection -->
                <div class="form-group">
                    <label class="form-label">Who is championing this goal?</label>
                    <div class="button-group button-group--three">
                        <button
                            type="button"
                            class="option-button option-button--champion"
                            [class.option-button--active]="championTypeValue === 'individual'"
                            (click)="selectChampionType('individual')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span>Individual</span>
                        </button>
                        <button
                            type="button"
                            class="option-button option-button--champion"
                            [class.option-button--active]="championTypeValue === 'organization'"
                            (click)="selectChampionType('organization')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="9" y1="3" x2="9" y2="21"/>
                                <line x1="15" y1="3" x2="15" y2="21"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="3" y1="15" x2="21" y2="15"/>
                            </svg>
                            <span>Organization</span>
                        </button>
                        <button
                            type="button"
                            class="option-button option-button--champion"
                            [class.option-button--active]="championTypeValue === 'anonymous'"
                            (click)="selectChampionType('anonymous')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                            </svg>
                            <span>Anonymous</span>
                        </button>
                    </div>
                </div>

                <!-- Individual Fields -->
                @if (championTypeValue === 'individual') {
                    <div class="form-group">
                        <label class="form-label">Your Name *</label>
                        <input
                            type="text"
                            class="form-input"
                            formControlName="name"
                            placeholder="John Doe" />
                    </div>
                }

                <!-- Organization Fields -->
                @if (championTypeValue === 'organization') {
                    <div class="form-group">
                        <label class="form-label">Organization Name *</label>
                        <input
                            type="text"
                            class="form-input"
                            formControlName="organizationName"
                            placeholder="Acme Foundation" />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Website</label>
                            <input
                                type="url"
                                class="form-input"
                                formControlName="website"
                                placeholder="https://example.org" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo URL</label>
                            <input
                                type="url"
                                class="form-input"
                                formControlName="logoUrl"
                                placeholder="https://..." />
                        </div>
                    </div>
                }

                <!-- Email (for all types) -->
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input
                        type="email"
                        class="form-input"
                        formControlName="email"
                        placeholder="you@example.com" />
                    <p class="form-hint">We'll notify you when your goal is approved or completed.</p>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <button
                        type="button"
                        class="btn-back"
                        (click)="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Back
                    </button>
                    <button
                        type="button"
                        class="btn-submit"
                        [disabled]="!aboutForm.valid"
                        (click)="submitProposal()">
                        Submit Proposal
                    </button>
                </div>
            </form>
            }
        </div>
    </div>
</app-popup>
